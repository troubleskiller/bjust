# åœ¨çº¿æ¨æ¼”å®Œæ•´åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

åœ¨çº¿æ¨æ¼”åŠŸèƒ½ç°å·²æ”¯æŒå®Œæ•´çš„æ¨¡å‹è¿è¡ŒæœåŠ¡ï¼Œç”¨æˆ·å¯ä»¥ï¼š
1. åˆ›å»ºé¢„æµ‹ä»»åŠ¡ï¼ˆæ”¯æŒå…¸å‹åœºæ™¯å’Œæ‰‹åŠ¨é…ç½®ï¼‰
2. å®æ—¶æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
3. è·å–ä»»åŠ¡ç»“æœï¼ˆåŒ…å«CSVå­—ç¬¦ä¸²å†…å®¹ï¼‰
4. åœæ­¢æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡

## æ ¸å¿ƒç‰¹æ€§

### âœ… å®é™…æ¨¡å‹è¿è¡Œ
- æ”¯æŒè°ƒç”¨çœŸå®çš„é¢„æµ‹æ¨¡å‹
- åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ç”¨æˆ·ç•Œé¢
- å®Œæ•´çš„è¿›ç¨‹ç®¡ç†å’Œç›‘æ§

### âœ… ä»»åŠ¡çŠ¶æ€ç®¡ç†
- `NOT_STARTED`: ä»»åŠ¡å·²åˆ›å»ºä½†æœªå¼€å§‹
- `IN_PROGRESS`: ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­
- `COMPLETED`: ä»»åŠ¡æˆåŠŸå®Œæˆ
- `ABORTED`: ä»»åŠ¡è¢«ä¸­æ­¢æˆ–å¤±è´¥

### âœ… ç»“æœè¿”å›
- ä»»åŠ¡å®Œæˆåè¿”å›å®Œæ•´çš„CSVç»“æœå­—ç¬¦ä¸²
- æ”¯æŒå¤§æ–‡ä»¶ç»“æœçš„å¤„ç†
- åŒ…å«ä»»åŠ¡æ‰§è¡Œæ—¶é—´ç­‰å…ƒä¿¡æ¯

### âœ… å…¸å‹åœºæ™¯é›†æˆ
- æ”¯æŒä½¿ç”¨å…¸å‹åœºæ™¯UUIDåˆ›å»ºä»»åŠ¡
- è¿”å›å…¸å‹åœºæ™¯çš„input.csvå†…å®¹
- åŒ…å«åœºæ™¯å…ƒä¿¡æ¯ï¼ˆåç§°ã€é¢„æµ‹ç±»å‹ç­‰ï¼‰

## APIæ¥å£

### 1. åˆ›å»ºé¢„æµ‹ä»»åŠ¡
```http
POST /api/v1/online_deduction/tasks
```

**è¯·æ±‚ç¤ºä¾‹ï¼ˆå…¸å‹åœºæ™¯ï¼‰:**
```json
{
  "model_uuid": "uuid-model-001",
  "prediction_mode": "link",
  "scenario_type": "typical_scenario",
  "point_config": {
    "scenario_uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
  },
  "param_config": {
    "frequency_band": "5.9GHz",
    "modulation_mode": "QPSK",
    "modulation_order": 4
  }
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "message": "success",
  "code": "200",
  "data": {
    "task_uuid": "pred-task-12345",
    "prediction_mode": "link",
    "scenario_type": "typical_scenario",
    "status": "IN_PROGRESS",
    "message": "ä»»åŠ¡å·²å¯åŠ¨",
    "scenario_csv_content": "39.9200,116.4200,30.0,39.9195,116.4195,1.5\n...",
    "scenario_info": {
      "scenario_name": "æµ‹è¯•åœºæ™¯",
      "prediction_type": "å•ç‚¹é¢„æµ‹",
      "tif_image_name": "nanjing"
    }
  }
}
```

### 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
```http
GET /api/v1/online_deduction/tasks/{task_uuid}/status
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "message": "success",
  "code": "200",
  "data": {
    "task_uuid": "pred-task-12345",
    "status": "IN_PROGRESS",
    "message": "ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­",
    "created_at": "2024-01-01T12:00:00",
    "start_time": "2024-01-01T12:00:05",
    "prediction_mode": "link",
    "scenario_type": "typical_scenario",
    "process_status": {
      "status": "running",
      "pid": 12345
    }
  }
}
```

### 3. è·å–ä»»åŠ¡ç»“æœ
```http
GET /api/v1/online_deduction/tasks/{task_uuid}/result
```

**å“åº”ç¤ºä¾‹ï¼ˆä»»åŠ¡å®Œæˆï¼‰:**
```json
{
  "message": "success",
  "code": "200",
  "data": {
    "task_uuid": "pred-task-12345",
    "status": "COMPLETED",
    "message": "ä»»åŠ¡å®Œæˆ",
    "result_csv_content": "lat,lon,height,path_loss\n39.9200,116.4200,30.0,95.5\n39.9250,116.4250,25.0,98.2\n...",
    "completed_at": "2024-01-01T12:05:30"
  }
}
```

### 4. åœæ­¢ä»»åŠ¡
```http
POST /api/v1/online_deduction/tasks/{task_uuid}/stop
```

## ä½¿ç”¨æµç¨‹

### æ ‡å‡†ä½¿ç”¨æµç¨‹
1. **åˆ›å»ºä»»åŠ¡** â†’ è·å¾— `task_uuid`
2. **è½®è¯¢çŠ¶æ€** â†’ æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
3. **è·å–ç»“æœ** â†’ è·å¾—CSVå­—ç¬¦ä¸²å†…å®¹

### ä»£ç ç¤ºä¾‹
```python
import requests
import time

# 1. åˆ›å»ºä»»åŠ¡
task_data = {
    "model_uuid": "uuid-model-001",
    "prediction_mode": "link",
    "scenario_type": "typical_scenario",
    "point_config": {"scenario_uuid": "your-scenario-uuid"},
    "param_config": {"frequency_band": "5.9GHz"}
}
response = requests.post("http://localhost:9001/api/v1/online_deduction/tasks", 
                        json=task_data)
task_uuid = response.json()['data']['task_uuid']

# 2. è½®è¯¢çŠ¶æ€
while True:
    status_response = requests.get(f"http://localhost:9001/api/v1/online_deduction/tasks/{task_uuid}/status")
    status = status_response.json()['data']['status']
    
    if status == 'COMPLETED':
        # 3. è·å–ç»“æœ
        result_response = requests.get(f"http://localhost:9001/api/v1/online_deduction/tasks/{task_uuid}/result")
        csv_content = result_response.json()['data']['result_csv_content']
        print(f"ä»»åŠ¡å®Œæˆï¼Œç»“æœé•¿åº¦: {len(csv_content)} å­—ç¬¦")
        break
    elif status == 'ABORTED':
        print("ä»»åŠ¡å¤±è´¥")
        break
    else:
        time.sleep(5)  # ç­‰å¾…5ç§’åå†æ¬¡æ£€æŸ¥
```

## æµ‹è¯•å·¥å…·

### å®Œæ•´åŠŸèƒ½æµ‹è¯•
```bash
python test_online_deduction_full.py
```

è¿™ä¸ªæµ‹è¯•è„šæœ¬ä¼šï¼š
1. è‡ªåŠ¨è·å–å¯ç”¨çš„å…¸å‹åœºæ™¯
2. åˆ›å»ºé¢„æµ‹ä»»åŠ¡
3. ç›‘æ§ä»»åŠ¡è¿›åº¦
4. è·å–æœ€ç»ˆç»“æœ
5. æ¼”ç¤ºåœæ­¢ä»»åŠ¡åŠŸèƒ½

### è¾“å‡ºç¤ºä¾‹
```
ğŸ§ª åœ¨çº¿æ¨æ¼”å®Œæ•´åŠŸèƒ½æµ‹è¯•
============================================================
æ­£åœ¨è·å–å…¸å‹åœºæ™¯åˆ—è¡¨...
âœ… æ‰¾åˆ°å…¸å‹åœºæ™¯: æµ‹è¯•åœºæ™¯_å·¥å‚å›­åŒº (UUID: a1b2c3d4-...)

============================================================
ğŸš€ åˆ›å»ºåœ¨çº¿æ¨æ¼”é¢„æµ‹ä»»åŠ¡
============================================================
ä½¿ç”¨å…¸å‹åœºæ™¯åˆ›å»ºä»»åŠ¡
âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ!
ä»»åŠ¡UUID: pred-task-12345
ä»»åŠ¡çŠ¶æ€: IN_PROGRESS
çŠ¶æ€æè¿°: ä»»åŠ¡å·²å¯åŠ¨

ğŸ“Š æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€: pred-task-12345
âœ… ä»»åŠ¡çŠ¶æ€: COMPLETED
çŠ¶æ€æè¿°: ä»»åŠ¡å®Œæˆ

ğŸ“„ è·å–ä»»åŠ¡ç»“æœ: pred-task-12345
âœ… ä»»åŠ¡çŠ¶æ€: COMPLETED
ğŸ“Š è¾“å‡ºCSVç»“æœ:
==================================================
 1: lat,lon,height,path_loss
 2: 39.9200,116.4200,30.0,95.5
 3: 39.9250,116.4250,25.0,98.2
...
==================================================
CSVå†…å®¹æ€»é•¿åº¦: 1024 å­—ç¬¦

ğŸŠ æµ‹è¯•å®Œæˆ! è·å¾— 1024 å­—ç¬¦çš„CSVç»“æœ
```

## é…ç½®è¦æ±‚

### ç¯å¢ƒå˜é‡
```python
# config.py
TASK_OUTPUT_DIR = 'storage/tasks/output'  # ä»»åŠ¡è¾“å‡ºç›®å½•
STORAGE_FOLDER = 'storage'                # å­˜å‚¨åŸºç¡€ç›®å½•
```

### ç›®å½•ç»“æ„
```
storage/
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ csv/           # è¾“å…¥CSVæ–‡ä»¶
â”‚   â””â”€â”€ output/        # è¾“å‡ºç»“æœç›®å½•
â”‚       â””â”€â”€ {task_uuid}/
â”‚           â””â”€â”€ result.csv
â”œâ”€â”€ model/             # æ¨¡å‹æ–‡ä»¶
â”‚   â””â”€â”€ {model_uuid}/
â”‚       â”œâ”€â”€ main.py
â”‚       â””â”€â”€ model_python_env/
â””â”€â”€ typical_scenarios/ # å…¸å‹åœºæ™¯
    â””â”€â”€ {type}_{uuid}/
        â”œâ”€â”€ input.csv
        â””â”€â”€ scenario_metadata.json
```

## æŠ€æœ¯ç‰¹ç‚¹

1. **å¼‚æ­¥æ‰§è¡Œ**: ä½¿ç”¨è¿›ç¨‹ç®¡ç†å™¨åå°è¿è¡Œæ¨¡å‹
2. **çŠ¶æ€æŒä¹…åŒ–**: ä»»åŠ¡çŠ¶æ€å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆå¯æ‰©å±•åˆ°æ•°æ®åº“ï¼‰
3. **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æ•è·å’Œé”™è¯¯ä¿¡æ¯è¿”å›
4. **èµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œè¿›ç¨‹èµ„æº
5. **æ‰©å±•æ€§**: æ”¯æŒä¸åŒç±»å‹çš„é¢„æµ‹æ¨¡å¼å’Œå‚æ•°é…ç½®

## æ³¨æ„äº‹é¡¹

1. **æ¨¡å‹è·¯å¾„**: éœ€è¦ç¡®ä¿æ¨¡å‹æ–‡ä»¶å­˜åœ¨äºæŒ‡å®šè·¯å¾„
2. **ç¯å¢ƒé…ç½®**: Pythonç¯å¢ƒå’Œä¾èµ–éœ€è¦æ­£ç¡®é…ç½®
3. **æƒé™é—®é¢˜**: ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ–‡ä»¶è¯»å†™æƒé™
4. **èµ„æºé™åˆ¶**: è¿›ç¨‹ç®¡ç†å™¨ä¼šé™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°é‡
5. **è¶…æ—¶è®¾ç½®**: é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡éœ€è¦é€‚å½“çš„è¶…æ—¶é…ç½®

## æ‰©å±•å»ºè®®

1. **æ•°æ®åº“å­˜å‚¨**: å°†ä»»åŠ¡çŠ¶æ€æŒä¹…åŒ–åˆ°æ•°æ®åº“
2. **é˜Ÿåˆ—ç®¡ç†**: å®ç°ä»»åŠ¡é˜Ÿåˆ—å’Œä¼˜å…ˆçº§ç®¡ç†
3. **ç»“æœç¼“å­˜**: ç¼“å­˜ä»»åŠ¡ç»“æœä»¥æé«˜è®¿é—®é€Ÿåº¦
4. **é€šçŸ¥æœºåˆ¶**: ä»»åŠ¡å®Œæˆæ—¶çš„ä¸»åŠ¨é€šçŸ¥åŠŸèƒ½
5. **èµ„æºç›‘æ§**: æ·»åŠ CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§ 